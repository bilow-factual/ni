#!/bin/bash
rm -f ni ni-boot ni-debug
{
  cat src/{core,prefix,gen,gentypes,fn,io}.pl \
      src/{data,datatypes,iotypes,iobind,iofns}.pl \
      src/{ops,optypes,main}.pl
  echo __END__
} > ni-debug

perl -ne '$i |= /^\s*DEBUG$/; print unless $i; $i &= !/^\s*DEBUG_END$/' \
  < ni-debug \
  | egrep -v '^\s*(#(\s.+)?)?$' \
  > ni-boot

sed -ri '2,6d; /^\s*DEBUG(_END)?/d' ni-debug

chmod 0500 ni-boot ni-debug

./ni-debug --self > /dev/null \
  && ./ni-boot --self > ni \
  && chmod +x ni
