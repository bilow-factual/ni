#!/bin/bash
# Builds a ni source image.

sources=( ni.c )

unsdoc() {
  perl -e \
    'print join "\n",grep /^\s*[^A-Z| ]/, split /\n(?:\s*\n)+/, join "", <>' \
    "$@"
}

cat > gen/ni-kernel <<EOF
awk '$(cat src/decompress.awk)' <<'EOF'
EOF

for f in "${sources[@]}"; do
  unsdoc src/$f.sdoc >> gen/ni-kernel
done

echo EOF >> gen/ni-kernel

cat > ni <<EOF
#!/bin/sh
e=\`mktemp\`
s=\`mktemp --suffix=.c\`
{
$(< gen/ni-kernel)
} > "\$s"
c99 "\$s" -o "\$e" && exec "\$e" "\$s" "\$@"
EOF
