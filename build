#!/bin/bash
# Builds a ni source image.

unsdoc() {
  perl -e 'print join "\n",
                 grep /^\h*[^A-Z| ]/,
                 split /\n(?:\h*\n)+(?:c\n)?/,
                 join "", <>' \
       "$@"
}

resource() {
  cd gen
  wc -l "$1"
  cat "$1"
  cd - > /dev/null
}

[[ -d gen ]] && rm -r gen
cp -r src gen

for f in ni.h nope.h math.h \
         stream.h \
         resources.c packet.c stream.c ni.c; do
  unsdoc src/$f.sdoc
done > gen/ni0.c

{ egrep    '^#include|^#define[^()\\]+$' < gen/ni0.c | sort | uniq
  egrep -v '^#include|^#define[^()\\]+$' < gen/ni0.c; } > gen/ni.c

unsdoc src/decompress.awk.sdoc > gen/decompress.awk

cat > gen/ni-kernel <<EOF
awk '$(< gen/decompress.awk)' <<'EOF'
EOF

# mktemp isn't universally available (not specified by POSIX), so implement our
# own cheesy version. mkdir will succeed iff we get the directory.
cat > gen/ni-header.sh <<'EOF'
#!/bin/sh
# ni self-compiling source image; not intended to be edited directly
# MIT license, see https://github.com/spencertipping/ni for details
prefix=${TMPDIR:-/tmp}/ni-$USER-$$
i=0
until mkdir "$prefix-$i" 2>&1 > /dev/null; do
  i=`expr $i + 1`
done
e=$prefix-$i/ni
s=$e.c
{
EOF

cat > gen/ni-footer.sh <<'EOF'
} > "$s"
c99 "$s" -o "$e" && exec "$e" "$s" "$prefix-$i" "$@"
EOF

for r in decompress.awk ni.c ni-header.sh ni-footer.sh usage; do
  resource $r
done >> gen/ni-kernel

echo EOF >> gen/ni-kernel

cat gen/ni-header.sh \
    gen/ni-kernel \
    gen/ni-footer.sh > gen/ni0 && chmod +x gen/ni0

gen/ni0 --self > gen/ni1 && chmod +x gen/ni1 || exit $?
gen/ni1 --self > ni      && chmod +x ni      || exit $?
