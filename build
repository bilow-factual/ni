#!/bin/bash
rm -f ni ni-boot ni-debug
{
  cat src/{core,prefix,gen,gentypes,fn,io}.pl \
      src/{data,datatypes,iotypes,iobind,iofns}.pl \
      src/{ops,optypes,module,main}.pl
  echo __END__
  cat lib/{geohash,sql}.pl
} > ni-debug

if grep FIXME ni-debug > /dev/null; then
  echo $(grep FIXME ni-debug | wc -l) "thing(s) to fix"
fi

perl -ne '$i |= /^\s*DEBUG$/; print unless $i; $i &= !/^\s*DEBUG_END$/' \
  < ni-debug \
  | egrep -v '^\s*(#(\s.+)?)?$' \
  | sed -r 's/^\s*//' \
  > ni-boot

sed -ri '2,6d; /^\s*DEBUG(_END)?/d' ni-debug

chmod 0500 ni-boot ni-debug

./ni-debug --self > /dev/null \
  && ./ni-boot --self > ni \
  && chmod +x ni
