#!/bin/bash
# Builds the ni image, first by assembling the self-modifying parts (./boot),
# and then by telling it to add modules. core/ is symlinked to gen/, which is
# produced by ./boot.

cd $(dirname $0)

./boot

[[ -d core ]] || ln -s gen core

./ni --internal/lib core/common
./ni --internal/lib core/gen
./ni --internal/lib core/stream
./ni --internal/lib core/meta

./ni --internal/lib core/col
./ni --internal/lib core/row
./ni --internal/lib core/facet

./ni --internal/lib core/pl
./ni --internal/lib core/python
./ni --internal/lib core/sql
./ni --internal/lib core/java

./ni --internal/lib core/hadoop
./ni --internal/lib core/pyspark

./ni --internal/lib doc

if [[ `./ni //ni` != "$(< ni)" ]]; then
  echo "ni is unstable under replication" >&2
  exit 1
fi

wc -c ni
