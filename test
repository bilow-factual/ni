#!/bin/bash
cd $(dirname $0)

./build
./lazytest $(find doc -name '*.md') > tests.sh

if [[ $1 == '-q' ]]; then
  docker run --security-opt=seccomp=unconfined -i -m 256M --rm -v $PWD:/data:ro \
    $(docker build -q -f env/ubuntu-16.04 .) /bin/bash <<'EOF'
    cd /tmp
    bash /data/tests.sh
EOF
else
  for e in env/alpine env/ubuntu-16.04; do
    echo
    echo "TESTING $e"
    echo

    docker run --security-opt=seccomp=unconfined -i -m 256M --rm -v $PWD:/data:ro \
      $(docker build -q -f $e .) /bin/bash <<'EOF'
      cd /tmp
      bash /data/tests.sh
EOF

    echo
  done
fi
