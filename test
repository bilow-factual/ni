#!/bin/bash
cd $(dirname $0)

envs=( alpine
       centos-5
       debian-wheezy
       ubuntu-12.04
       ubuntu-16.04 )

./build
./lazytest $(find doc -name '*.md') > tests.sh

tests() { echo 'cd /tmp; bash /data/tests.sh'; }
image() { docker build -q -f env/$1 .; }

c=$1
shift

docker_magic="--security-opt=seccomp=unconfined"
docker_opts="$docker_magic -i -m 256M --rm -v $PWD:/data:ro"

case $c in
-b|--build)
  for e in ${envs[@]}; do
    echo
    echo "BUILDING $e"
    echo
    docker build -f $e .
  done
  ;;

-q|--quick)
  tests | docker run $docker_opts $(image ubuntu-16.04) /bin/bash
  ;;

-r|--repl)
  docker run $docker_opts -t $(image ${1:-ubuntu-16.04}*) /bin/bash
  ;;

*)
  for e in ${envs[@]}; do
    echo
    echo "TESTING $e"
    echo
    tests | docker run $docker_opts $(image $e) /bin/bash
    echo
  done
esac
