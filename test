#!/bin/bash
cd $(dirname $0)

./build
./lazytest $(find doc -name '*.md') > tests.sh

if [[ $1 == '-q' ]]; then
  docker run -i -m 256M --rm -v $PWD:/data:ro \
    $(docker build -q -f env/ubuntu-16.04 .) /bin/bash <<'EOF'
    cd /tmp
    bash /data/tests.sh
EOF
else
  for e in env/*; do
    echo
    echo "TESTING $e"
    echo

    if docker build -f $e .; then
      docker run -i -m 256M --rm -v $PWD:/data:ro \
        $(docker build -q -f $e .) /bin/bash <<'EOF'
        cd /tmp
        bash /data/tests.sh
EOF
  else
      echo "\033[1;31mdocker build failed\033[0;0m"
    fi

    echo
  done
fi
